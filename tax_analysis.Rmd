---
title: "tax_analysis"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(tidyverse)
library(ISLR)
```

```{r message=FALSE, warning=FALSE}
audits <- here::here("data/cleaned/auditsData_2019.04.03.csv") %>%
    read_csv()
race_county <- here::here("data/cleaned/race_eth_county.csv") %>%
    read_csv()
incomes <- here::here("data/cleaned/incomes.csv") %>%
    read_csv()
joined <- full_join(audits, race_county, by = "fips") %>%
  full_join(., incomes, by = "fips") %>% 
  select(fips, state.x, county, n_returns, estimated_exams, audit_rate, white, black, indian, asian, hawaiian, other, two, non_his, hispanic, median_income) 
```

```{r}
joined <- joined %>%
  mutate(non_white = black + indian + asian + hawaiian + other + two, 
         pred_white = as.integer(ifelse(white >= non_white, 1, 0)))
```


```{r}
fit = lm(audit_rate ~ pred_white + median_income, data = joined)
summary(fit)
```
```{r}
# For predominantly non-white counties $y = -.00002935x + 10.35$
# For predominantly white counties, $y = -.00002935x + 9.23$
```

```{r}
ggplot(data = joined, aes(x = county, y = audit_rate, color = pred_white)) +
  geom_point() 
```

```{r}
ggplot(data = joined, aes(x = median_income, y = audit_rate, color = pred_white)) +
  geom_point() + 
  geom_smooth(method = "lm")
```


```{r}
ggplot(data = joined, aes(x = median_income, y = audit_rate, color = pred_white)) +
  geom_point() +
  stat_function(fun = function(x) -.00002935*x + 10.35) +
  stat_function(fun = function(x) -.00002935*x + 9.23)
```

```{r}
better_fit = lm(audit_rate ~ poly(median_income, 2, raw = TRUE) + pred_white, data = joined)
summary(better_fit)
```

```{r}
ggplot(joined, aes(median_income, audit_rate)) +
  geom_point() +
  stat_smooth(method = lm, formula = y ~ poly(x, 2, raw = TRUE))
```

```{r}
better_fit2 = lm(audit_rate ~ poly(pred_white, 3, raw = TRUE) + median_income, data = joined)
summary(better_fit2)
```

```{r}
ggplot(joined, aes(median_income, audit_rate)) +
  geom_point() +
  stat_smooth(method = lm, formula = y ~ poly(x, 3, raw = TRUE))
```



